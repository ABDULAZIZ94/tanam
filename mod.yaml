specVersion: v1beta1
name: tanam
version: 0.100.0
author:
  authorName: Oddbit
  email: tanam@oddbit.id
  url: https://github.com/oddbit/tanam
description:
  Adds a web CMS to your Firebase.
license: Apache-2.0
roles:
  - role: storage.admin
    reason: allows the mod to store uploaded images and documents in Cloud Storage
  - role: datastore.user
    reason: allows the mod to store all the website information and content
  - role: firebasedatabase.admin
    reason: allows the mod to use RTDB as an event pipeline / task queue

params:
  - param: TANAM_LOCATION
    label: Deployment Location
    description: >-
      Where should the mod be deployed? (*us-central1, us-east1, europe-west1, europe-west2, asia-east2, asia-northeast1*)
      Pick a location that is close to your Firestore database.

      See
      https://firebase.google.com/docs/functions/locations#selecting_regions_for_firestore_and_storage.
    validationRegex: ^us-central1$|^us-east1$|^europe-west1$|^europe-west2$|^asia-east2$|^asia-northeast1
    validationErrorMessage: >
      Invalid location, please pick one of: us-central1, us-east1, europe-west1, europe-west2, asia-east2, asia-northeast1
    default: us-central1

  - param: TANAM_API_KEY
    label: Firebase web app API key
    description: Paste in the `apiKey` from the web app configuration.
    required: true

  - param: TANAM_AUTH_DOMAIN
    label: Firebase web app API key
    description: Paste in the `authDomain` from the web app configuration.
    default: ${PROJECT_ID}.firebaseapp.com
    required: true

  - param: TANAM_DATABASE_URL
    label: Database URL
    description: Paste in the `databaseURL` from the web app configuration.
    default: ${DATABASE_URL}
    required: true

  - param: TANAM_PROJECT_ID
    label: Database URL
    description: Paste in the `projectId` from the web app configuration.
    default: ${PROJECT_ID}
    required: true

  - param: TANAM_STORAGE_BUCKET
    label: Storage bucket
    description: Paste in the `storageBucket` from the web app configuration.
    default: ${STORAGE_BUCKET}
    required: true

  - param: TANAM_MESSAGING_SENDER_ID
    label: Messaging sender ID
    description: Paste in the `messagingSenderId` from the web app configuration.
    required: true

  - param: TANAM_APP_ID
    label: App Id
    description: Paste in the `appId` from the web app configuration.
    required: true

  - param: TANAM_SUPER_ADMIN
    label: Super admin user
    description: >
      Specify the email of the first super admin that will be given full control over
      the CMS. This should most likely be your own email. You can add more users and
      admins later on, once you have logged in to Tanam.
    required: true

resources:


  ## ###############################################
  ## triggers/cache.ts
  ##

  - name: handleCacheTask
    type: firebasemods.v1beta1.function
    properties:
      runtime: nodejs8
      eventTrigger:
        location: ${TANAM_LOCATION}
        eventType: providers/google.firebase.database/eventTypes/ref.create
        resource: projects/_/instances/${DATABASE_URL}/refs/tanam/{siteId}/tasks/cache/{action}/{taskId}



  ## ###############################################
  ## triggers/document-type.ts
  ##
  - name: cleanUpDocumentsOfType
    type: firebasemods.v1beta1.function
    properties:
      runtime: nodejs8
      eventTrigger:
        location: ${TANAM_LOCATION}
        eventType: providers/cloud.firestore/eventTypes/document.delete
        resource: projects/${PROJECT_ID}/databases/(default)/documents/tanam/{siteId}/document-types/{type}

  - name: updateDocumentsStandaloneValue
    type: firebasemods.v1beta1.function
    properties:
      runtime: nodejs8
      eventTrigger:
        location: ${TANAM_LOCATION}
        eventType: providers/cloud.firestore/eventTypes/document.update
        resource: projects/${PROJECT_ID}/databases/(default)/documents/tanam/{siteId}/document-types/{type}



  ## ###############################################
  ## triggers/documents.ts
  ##
  - name: onCreateDocumentRequestRendering
    type: firebasemods.v1beta1.function
    properties:
      runtime: nodejs8
      eventTrigger:
        location: ${TANAM_LOCATION}
        eventType: providers/cloud.firestore/eventTypes/document.create
        resource: projects/${PROJECT_ID}/databases/(default)/documents/tanam/{siteId}/documents/{documentId}

  - name: onDeleteDocumentCleanUp
    type: firebasemods.v1beta1.function
    properties:
      runtime: nodejs8
      eventTrigger:
        location: ${TANAM_LOCATION}
        eventType: providers/cloud.firestore/eventTypes/document.delete
        resource: projects/${PROJECT_ID}/databases/(default)/documents/tanam/{siteId}/documents/{documentId}

  - name: onUpdateDocumentRequestRendering
    type: firebasemods.v1beta1.function
    properties:
      runtime: nodejs8
      eventTrigger:
        location: ${TANAM_LOCATION}
        eventType: providers/cloud.firestore/eventTypes/document.update
        resource: projects/${PROJECT_ID}/databases/(default)/documents/tanam/{siteId}/documents/{documentId}

  - name: updateDocumentStatusCounter
    type: firebasemods.v1beta1.function
    properties:
      runtime: nodejs8
      eventTrigger:
        location: ${TANAM_LOCATION}
        eventType: providers/cloud.firestore/eventTypes/document.write
        resource: projects/${PROJECT_ID}/databases/(default)/documents/tanam/{siteId}/documents/{documentId}

  - name: saveRevision
    type: firebasemods.v1beta1.function
    properties:
      runtime: nodejs8
      eventTrigger:
        location: ${TANAM_LOCATION}
        eventType: providers/cloud.firestore/eventTypes/document.update
        resource: projects/${PROJECT_ID}/databases/(default)/documents/tanam/{siteId}/documents/{documentId}

  - name: deleteRevisions
    type: firebasemods.v1beta1.function
    properties:
      runtime: nodejs8
      eventTrigger:
        location: ${TANAM_LOCATION}
        eventType: providers/cloud.firestore/eventTypes/document.delete
        resource: projects/${PROJECT_ID}/databases/(default)/documents/tanam/{siteId}/documents/{documentId}

  - name: deleteFieldReferences
    type: firebasemods.v1beta1.function
    properties:
      runtime: nodejs8
      eventTrigger:
        location: ${TANAM_LOCATION}
        eventType: providers/cloud.firestore/eventTypes/document.delete
        resource: projects/${PROJECT_ID}/databases/(default)/documents/tanam/{siteId}/{contentType}/{id}

  - name: heartbeat
    type: firebasemods.v1beta1.function
    properties:
      runtime: nodejs8
      eventTrigger:
        location: ${TANAM_LOCATION}
        eventType: google.pubsub.topic.publish
        resource: projects/${PROJECT_ID}/topics/firebase-schedule-heartbeat-${TANAM_LOCATION}



  ## ###############################################
  ## triggers/file.ts
  ##

  - name: onDeleteUserFile
    type: firebasemods.v1beta1.function
    properties:
      runtime: nodejs8
      eventTrigger:
        location: ${TANAM_LOCATION}
        eventType: providers/cloud.firestore/eventTypes/document.delete
        resource: projects/${PROJECT_ID}/databases/(default)/documents/tanam/{siteId}/files/{fileId}

  - name: onCreateThemeAssetsFile
    type: firebasemods.v1beta1.function
    properties:
      runtime: nodejs8
      eventTrigger:
        location: ${TANAM_LOCATION}
        eventType: providers/cloud.firestore/eventTypes/document.create
        resource: projects/${PROJECT_ID}/databases/(default)/documents/tanam/{siteId}/themes/{themeId}/assets/{assetId}

  - name: onUpdateThemeAssetsFile
    type: firebasemods.v1beta1.function
    properties:
      runtime: nodejs8
      eventTrigger:
        location: ${TANAM_LOCATION}
        eventType: providers/cloud.firestore/eventTypes/document.update
        resource: projects/${PROJECT_ID}/databases/(default)/documents/tanam/{siteId}/themes/{themeId}/assets/{assetId}

  - name: onDeleteThemeAssetsFile
    type: firebasemods.v1beta1.function
    properties:
      runtime: nodejs8
      eventTrigger:
        location: ${TANAM_LOCATION}
        eventType: providers/cloud.firestore/eventTypes/document.delete
        resource: projects/${PROJECT_ID}/databases/(default)/documents/tanam/{siteId}/themes/{themeId}/assets/{assetId}



  ## ###############################################
  ## triggers/site.ts
  ##

  - name: registerHost
    type: firebasemods.v1beta1.function
    properties:
      runtime: nodejs8
      eventTrigger:
        location: ${TANAM_LOCATION}
        eventType: providers/google.firebase.database/eventTypes/ref.create
        resource: projects/_/instances/${DATABASE_URL}/refs/tanam/{siteId}/domains/{hash}



  ## ###############################################
  ## triggers/storage.ts
  ##
  - name: onUserImageUpload
    type: firebasemods.v1beta1.function
    properties:
      runtime: nodejs8
      eventTrigger:
        location: ${TANAM_LOCATION}
        eventType: google.storage.object.delete
        resource: projects/_/buckets/${TANAM_STORAGE_BUCKET}

  - name: onThemeAssetsFileUpload
    type: firebasemods.v1beta1.function
    properties:
      runtime: nodejs8
      eventTrigger:
        location: ${TANAM_LOCATION}
        eventType: google.storage.object.finalize
        resource: projects/_/buckets/${TANAM_STORAGE_BUCKET}



  ## ###############################################
  ## triggers/theme.ts
  ##

  - name: onUpdateActiveTheme
    type: firebasemods.v1beta1.function
    properties:
      runtime: nodejs8
      eventTrigger:
        location: ${TANAM_LOCATION}
        eventType: providers/cloud.firestore/eventTypes/document.update
        resource: projects/${PROJECT_ID}/databases/(default)/documents/tanam/{siteId}

  - name: onDeleteThemeDeleteTemplates
    type: firebasemods.v1beta1.function
    properties:
      runtime: nodejs8
      eventTrigger:
        location: ${TANAM_LOCATION}
        eventType: providers/cloud.firestore/eventTypes/document.delete
        resource: projects/${PROJECT_ID}/databases/(default)/documents/tanam/{siteId}/themes/{themeId}

  - name: onDeleteThemeDeleteAssets
    type: firebasemods.v1beta1.function
    properties:
      runtime: nodejs8
      eventTrigger:
        location: ${TANAM_LOCATION}
        eventType: providers/cloud.firestore/eventTypes/document.delete
        resource: projects/${PROJECT_ID}/databases/(default)/documents/tanam/{siteId}/themes/{themeId}

  - name: onWriteTemplateUpdateCache
    type: firebasemods.v1beta1.function
    properties:
      runtime: nodejs8
      eventTrigger:
        location: ${TANAM_LOCATION}
        eventType: providers/cloud.firestore/eventTypes/document.write
        resource: projects/${PROJECT_ID}/databases/(default)/documents/tanam/{siteId}/themes/{themeId}/templates/{templateId}



  ## ###############################################
  ## triggers/users.ts
  ##
  - name: createUser
    type: firebasemods.v1beta1.function
    properties:
      runtime: nodejs8
      eventTrigger:
        location: ${TANAM_LOCATION}
        eventType: providers/firebase.auth/eventTypes/user.create
        resource: projects/${PROJECT_ID}

  - name: deleteUser
    type: firebasemods.v1beta1.function
    properties:
      runtime: nodejs8
      eventTrigger:
        location: ${TANAM_LOCATION}
        eventType: providers/firebase.auth/eventTypes/user.delete
        resource: projects/${PROJECT_ID}

  - name: updateAuthRoles
    type: firebasemods.v1beta1.function
    properties:
      runtime: nodejs8
      eventTrigger:
        location: ${TANAM_LOCATION}
        eventType: providers/cloud.firestore/eventTypes/document.update
        resource: projects/${PROJECT_ID}/databases/(default)/documents/tanam/{siteId}/users/{uid}
